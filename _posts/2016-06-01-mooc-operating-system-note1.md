---
layout: post
title: "MOOC 操作系统 课程笔记"
description: "MOOC Operating System note"
keywords: operating system, os, mooc
category: OperatingSystem
tags: [operating system, os]
---

# 第三讲  启动、中断、异常和系统调用
## 3.1 BIOS
系统启动必须要找到一个特定的代码执行，此代码为BIOS，

BIOS 存储在内存的ROM段
系统启动开始时置CS:IP = 0xf000:fff0

系统处于实模式下, 此时：

**PC = 16*CS + IP**, 则PC= 0xffff0（共5*4 = 20位地址空间）

所以BIOS可得到约共20位地址空间（1MB）

### BIOS实现的功能
BIOS作为启动固件之用，那么首先需要有硬盘读写的能力以及其他包括：

* 基本输入输出程序（读写硬盘，键盘输入，屏幕输出）
* 系统设置信息(系统配置，例如从硬盘启动还是网络启动还是光盘启动，U盘启动)
* 开机后自检程序
* 系统自启动程序等

### 具体过程

#### 加载程序
将加载程序从磁盘的引导扇区（512字节）加载到0x7c00 (0111 1100 0000 0000)

（那么加载程序最大只有512字节）

跳转到 CS:IP = 0000:7c00

控制权转到此加载程序

加载程序功能：

* 将操作系统的代码和数据从硬盘加载到内存中
* 跳转到操作系统的起始地址（控制权交给了操作系统）

问题：
为什么需要一个 中间的加载程序加载操作系统，而不是BIOS直接把操作系统内核映像读进去呢？

答：首先磁盘上有各种格式的文件系统(NTFS，FAT32等)，那么识别文件系统格式可以由加载程序完成

#### BIOS系统调用
BIOS以中断方式提供基本的I/O功能，例如：

* INT 10h: 字符显示
* INT 13h: 磁盘扇区读写
* INT 15h: 检测内存大小
* INT 16h: 读取键盘输入

BIOS提供最简单最基本的IO功能，其使用也受到很大限制（例如对于x86,只能在实模式下访问）。

## 3.2 系统启动流程
参考：[计算机是如何启动的](http://www.ruanyifeng.com/blog/2013/02/booting.html)

### MBR格式
MBR共512字节，包括：

1. 启动代码: 1-446字节，共446字节（代码段）
2. 硬盘分区表: 447-510字节，共64字节（数据段）可用4分区，每分区16字节，猜测这意味着一个分区的寻址空间约2^128字节。
3. MBR结束标志：511-512字节，共2字节，0x55AA

在BIOS中不是有启动顺序么？比如U盘启动就将其顺序放置在第一位，

实际过程是按照启动顺序检查存储设备最前面的512字节，如果最后以0x55AA结尾，就认为是MBR（Master Boot Record,主引导记录）

MBR之后跳到分区引导扇区上，

分区引导扇区格式：

## 3.3 中断、异常和系统调用


# 实验部分
## 3-1 x86启动顺序

step1. 各寄存器初始化到初始值，关键注意CS和EIP的值，CS=F000H，EIP=0000FFF0H，Base=FFFF0000H

为了兼容早期的8086，初始启动为实模式，后续才到保护模式

### Bootloader做的事情

1. 使能保护模式（将特殊寄存器CR0从0置为1，从实模式切换到保护模式），段机制能正常工作了
2. 读取kernel代码（可能保存在多个扇区）到内存中固定的位置
3. 修改CS，EIP控制权转移给内核
4. 建立gdt（全局描述符表）结构

## 3-2 C函数调用的实现

